<!DOCTYPE html>

<html>

<head>
<style>
body {
	background-color: #fff;
	color: #111;
	margin: 0px;
	overflow: hidden;
	font-family: Monospace;
	font-size: 20px;
	position: absolute;
}
#info {
	position: absolute;
	top: 5%;
	width: 100%;
	padding: 5px;
	text-align: center;
	color: #ffff00
}
#loading {
	z-index: 10;
	position: absolute;
	width: 100%;
	height: 100%;
	text-align: center;
	margin: 0 auto;
	color: #ffffff;
	font-size: 40px;
}
</style>
</head>

<body>
<div id="loading" class="align-middle">loading...</div>
<div id="info">obj loader three.js</div>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/loaders/MTLLoader.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/loaders/OBJLoader.js"></script>

<script>
$("#info").hide();
var camera, scene, renderer;
var objNameList = [], finish = false;
init();
animate();

function init() {

	scene = new THREE.Scene();

	renderer = new THREE.WebGLRenderer();
	renderer.setSize(window.innerWidth, window.innerHeight);
	renderer.setClearColor(0x888888);
	document.body.appendChild(renderer.domElement);

	camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
	camera.position.y = 100;
	camera.position.z = 100;
	let controls = new THREE.OrbitControls(camera, renderer.domElement);
	
	window.addEventListener('resize', onWindowResize, false); // 隨視窗大小改變
	
	let gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
	scene.add(gridXZ);
	readModel("Trump");
	//objNameList.push("Trump");
	let light = new THREE.AmbientLight( 0xffffff ); // soft white light
	scene.add( light );
}

function onWindowResize() {
	windowHalfX = window.innerWidth / 2;
	windowHalfY = window.innerHeight / 2;
	
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	
	renderer.setSize(window.innerWidth, window.innerHeight);
}

function readModel (modelName, targetSize=40) {
	
	objNameList.push(modelName);
	let onProgress = function(xhr) {
		
		if (xhr.lengthComputable) {
		let percentComplete = xhr.loaded / xhr.total * 100;
			console.log(Math.round(percentComplete, 2) + '% downloaded');
		}
		
	};
	
	let onError = function(xhr) {};
	
	let mtlLoader = new THREE.MTLLoader();
	mtlLoader.setPath('models/');
	mtlLoader.load(modelName+'.mtl', function(materials) {
		
		materials.preload();
		
		let objLoader = new THREE.OBJLoader();
		objLoader.setMaterials(materials);
		objLoader.setPath('models/');
		objLoader.load(modelName+'.obj', function(object) {
			
			let theObject =  unitize (object, targetSize);
			theObject.add ( new THREE.BoxHelper (theObject) )
			theObject.name = modelName;
			scene.add (theObject);
			theObject.setRotationFromEuler (new THREE.Euler (0, 3.1416, 0, 'XYZ'))
			// 根據OBJ調整
		}, onProgress, onError);
		
	});

}

////////////////////////////////////////
// wrap an Object3D around the given object
// so that it is centered at +Y axis
// 
function unitize (object, targetSize) {  
	
	// find bounding box of 'object'
	let box3 = new THREE.Box3();
	box3.setFromObject (object);
	let size = new THREE.Vector3();
	size.subVectors (box3.max, box3.min);
	let center = new THREE.Vector3();
	center.addVectors(box3.max, box3.min).multiplyScalar (0.5);
	
	console.log ('center: ' + center.x + ', '+center.y + ', '+center.z );
	console.log ('size: ' + size.x + ', ' +  size.y + ', '+size.z );
	
	// uniform scaling according to objSize
	let objSize = Math.max (size.x, size.y, size.z);
	let scaleSet = targetSize/objSize;
	
	let theObject =  new THREE.Object3D();
	theObject.add (object);
	object.scale.set (scaleSet, scaleSet, scaleSet);
	object.position.set (-center.x*scaleSet, -center.y*scaleSet + size.y/2*scaleSet, -center.z*scaleSet);
	
	return theObject;
	
}

function animate() {

	if (!finish) {
		console.log("loading...");
		let isOK = true;
		objNameList.forEach(function (name) {
			if (scene.getObjectByName(name) === undefined) {
				isOK = false;
			}
		});
		if (isOK) {
			//loading結束
			document.getElementById("loading").style.display = "none";
			$("#info").show();
			finish = !finish;
		}
	} else {
		render()
	}
	requestAnimationFrame(animate);
	
}

function render() {

	renderer.render(scene, camera);

}

</script>
</body>

</html>